{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "eastus",
      "metadata": {
        "description": "Azure Region for the site deployment. All Resources provisioned are created here"
      }
    },
    "isMultiTier": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "Indicates whether the deployment is a multi-tier deployment"
      }
    },
    "environment": {
      "type": "string",
      "defaultValue": "AzureCloud",
      "allowedValues": [
        "AzureCloud",
        "AzureGermanCloud",
        "AzureUSGovernment",
        "AzureChinaCloud"
      ],
      "metadata": {
        "description": "(Optional) Azure Environment for the deployment. E.g:- Public Azure, U.S. Gov. Cloud, Azure Germany, Azure China"
      }
    },
    "deploymentPrefix": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) Prefix applied to all resources provisioned as part of this template"
      },
      "maxLength": 3
    },
    "usesPrivateIP": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether Azure Files (SMB protocol) is used for the server config and portal content store"
      }
    },
    "deployPublicIPWhenUsingPrivateIP": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "(Optional) Deploys an unused public IP when using a Private Ip as Application Gateway V2 doesn't support only Private IP deployments yet."
      }
    },
    "usesExistingPublicIP": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether to use existing Public IP is usesPrivateIP is false"
      }
    },
    "existingPublicIPResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the Resource Group for the existing Public IP"
      }
    },
    "existingPublicIPName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Name of the existing Public IP"
      }
    },
    "dnsPrefixForPublicIpAddress": {
      "type": "string",
      "maxLength": 80,
      "defaultValue": "",
      "metadata": {
        "description": "DNS name for the Public IP address resource asociated with the site deployment. It needs to be unique across the region of deployment"
      }
    },
    "externalDnsHostName": {
      "type": "string",
      "metadata": {
        "description": "DNS name for the site deployment. It will be a custom domain (e.g. mysite.contoso.com) if using a Private IP or an SSL certificate, otherwise will be the Azure DNS <dnsPrefixForPublicIpAddress>.<location>.cloudapp.azure.com"
      }
    },
    "secondaryDnsHostName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Private DNS name for the site deployment. It will be a custom domain (e.g. mysite.contoso.com) if using a Private IP or an SSL certificate, otherwise will be the Azure DNS <dnsPrefixForPublicIpAddress>.<location>.cloudapp.azure.com"
      }
    },
    "sslCertificateFileName": {
      "type": "string",
      "metadata": {
        "description": "File name for the SSL Certificate"
      },
      "defaultValue": ""
    },
    "sslCertificateData": {
      "type": "string",
      "metadata": {
        "description": "Base-64 encoded form of the .pfx file. This is the cert terminating on the Application Gateway."
      },
      "defaultValue": ""
    },
    "sslCertificatePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for .pfx certificate"
      },
      "defaultValue": ""
    },
    "publicKeySSLCertificateFileName": {
      "type": "string",
      "metadata": {
        "description": "File name for the Public Key SSL Certificate"
      },
      "defaultValue": ""
    },
    "useSelfSignedInternalSSLCertificate": {
      "type": "bool",
      "metadata": {
        "description": "Use Self Signed Internal Certificate"
      },
      "defaultValue": true
    },
    "selfSignedSSLCertificatePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Private Key for the Backend Self signed SSL Certificate"
      },
      "defaultValue": ""
    },
    "serverInternalCertificateFileName": {
      "type": "string",
      "metadata": {
        "description": "File name for the SSL Certificate"
      },
      "defaultValue": ""
    },
    "serverInternalCertificatePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Accessible file path for SSL Certificate"
      },
      "defaultValue": ""
    },
    "portalInternalCertificateFileName": {
      "type": "string",
      "metadata": {
        "description": "File name for the SSL Certificate"
      },
      "defaultValue": ""
    },
    "portalInternalCertificatePassword": {
      "type": "securestring",
      "metadata": {
        "description": "Accessible file path for SSL Certificate"
      },
      "defaultValue": ""
    },
    "virtualNetworkResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Resource Group for the existing Virtual Network specified with the 'existingVirtualNetworkName' parameter"
      }
    },
    "existingVirtualNetworkName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Virtual Network"
      }
    },
    "subnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Subnet within the Virtual Network specified with the 'existingVirtualNetworkName' parameter"
      }
    },
    "outboundConnectivityMethod": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "LoadBalancer",
        "NatGateway"
      ]
    },
    "natGatewayResourceGroup": {
      "type": "string",
      "defaultValue": ""
    },
    "natGatewayName": {
      "type": "string",
      "defaultValue": ""
    },
    "appGatewaySubnetName": {
      "type": "string",
      "metadata": {
        "description": "Name of the existing Subnet within the Virtual Network specified with the 'existingVirtualNetworkName' parameter"
      }
    },
    "isUpdatingCertificates": {
      "type": "bool",
      "metadata": {
        "description": "True if updating certificates of an existing deployment"
      },
      "defaultValue": false
    },
    "appGatewayPrivateIP": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Available IP address in Application Gateway Subnet Range to be used with external dns name"
      }
    },
    "appGatewayPrivateIPSubnet": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Subnet associated with Private IP"
      }
    },
    "appGatewayName": {
      "type": "string",
      "metadata": {
        "description": "Name of Application Gateway Resource"
      }
    },
    "appGatewayResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Name of Application Gateway Resource Group Name"
      }
    },
    "windowsServerBaseImageReferenceVersion": {
      "type": "string",
      "metadata": {
        "description": "Windows Base Image reference version to be either used for RDP jump box or Fileshare Machine"
      },
      "defaultValue": "latest"
    },
    "userAssignedIdentities": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "User Assigned Identity"
      }
    },
    "adminUsername": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Username for the Virtual Machine Administrator (Windows) Account"
      }
    },
    "adminPassword": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Password for the Virtual Machine Administrator (Windows) Account"
      }
    },
    "virtualMachines": {
      "type": "array",
      "metadata": {
        "description": "Array of Virtual Machines to be provisioned in the deployment"
      }
    },
    "virtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of names for the Virtual Machines with Portal, Server and DataStore. A maximum of 2 names may be specified for the single tier base deployment"
      }
    },
    "fileShareVirtualMachineName": {
      "type": "string",
      "metadata": {
        "description": "Name of the File Share Virtual Machine"
      },
      "defaultValue": "DummyFS"
    },
    "serverVirtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of virtual machine names for the Server Tier"
      },
      "defaultValue": ""
    },
    "portalVirtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of virtual machine names for the Portal Tier"
      },
      "defaultValue": ""
    },
    "dataStoreVirtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of virtual machine names for the Data Store Tier"
      },
      "defaultValue": ""
    },
    "spatiotemporalBigDataStoreVirtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of virtual machine names for the Spatiotemporal Big Data Store Tier"
      },
      "defaultValue": ""
    },
    "isMultiMachineSpatiotemporalBigDataStore": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether SpatioTemporal Big Datastore is a multi machine setup"
      }
    },
    "isTileCacheDataStoreClustered": {
      "type": "bool",
      "metadata": {
        "description": "TileCache Datastore architecture mode set to `cluster` if true, else `masterSlave`"
      },
      "defaultValue": false
    },
    "isMultiMachineTileCacheDataStore": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether TileCache Datastore is a multi machine setup"
      }
    },
    "tileCacheDataStoreVirtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of virtual machine names for the Tile Cache Data Store Tier"
      },
      "defaultValue": ""
    },
    "graphDataStoreVirtualMachineNames": {
      "type": "string",
      "metadata": {
        "description": "Comma seperated list of virtual machine names for the Graph Data Store Tier"
      },
      "defaultValue": ""
    },
    "primaryGraphStoreMachineName": {
      "type": "string",
      "metadata": {
        "description": "Primary graph store machine name"
      },
      "defaultValue": ""
    },
    "graphStoreBackupStorageAccountEndpoint": {
      "type": "string",
      "defaultValue": "placeholder",
      "metadata": {
        "description": "Graph Data Store Backup Storage Account"
      }
    },
    "graphStoreBackupLocation": {
      "type": "string",
      "metadata": {
        "description": "Graph Data Store Backup Location - Container Name and path"
      },
      "defaultValue": ""
    },
    "graphStoreBackupStorageAccountKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Graph Data Store Backup Storage Account Key"
      }
    },
    "timeZoneId": {
      "type": "string",
      "defaultValue": "Pacific Standard Time",
      "metadata": {
        "description": "(Optional) Standard Id for the timezone to set for the Virtual Machines in the deployment"
      }
    },
    "enableAutomaticUpdates": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether to enable Automatic (Windows) Operating System updates"
      }
    },
    "joinWindowsDomain": {
      "type": "bool",
      "metadata": {
        "description": "(Optional) Indicates whether the virtual machines should join an existing Windows Active Directory which provides domain join and DNS services in the Virtual Network"
      },
      "defaultValue": false
    },
    "windowsDomainName": {
      "type": "string",
      "metadata": {
        "description": "(Optional) Domain FQDN where the virtual machine will be joined. Required if joinWindowsDomain = true"
      },
      "defaultValue": ""
    },
    "windowsDomainAdministratorUserName": {
      "type": "string",
      "metadata": {
        "description": "(Optional) Username for the Active Directory Domain Administrator account where the virtual machine will be joined. Required if joinWindowsDomain = true"
      },
      "defaultValue": ""
    },
    "windowsDomainAdministratorPassword": {
      "type": "securestring",
      "metadata": {
        "description": "(Optional) Password for the Active Directory Domain Administrator account where the virtual machine will be joined. Required if joinWindowsDomain = true"
      },
      "defaultValue": ""
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Azure Monitor Logs workspace name"
      },
      "defaultValue": ""
    },
    "logAnalyticsWorkspaceResourceGroupName": {
      "type": "string",
      "metadata": {
        "description": "Azure Monitor Logs Workspace Resource Group Name"
      },
      "defaultValue": ""
    },
    "azureMonitoringAgentUserAssignedIdentityId": {
      "type": "string",
      "metadata": {
        "description": "Azure Monitoring Agent User Assigned Identity"
      },
      "defaultValue": ""
    },
    "azureMonitoringAgentUserAssignedIdentityClientId": {
      "type": "string",
      "metadata": {
        "description": "Azure Monitoring Agent User Assigned Identity"
      },
      "defaultValue": ""
    },
    "serverContext": {
      "type": "string",
      "metadata": {
        "description": "ArcGIS Server Site Context"
      },
      "defaultValue": "server"
    },
    "portalContext": {
      "type": "string",
      "metadata": {
        "description": "ArcGIS Portal Site Context"
      },
      "defaultValue": "portal"
    },
    "arcgisServiceAccountUserName": {
      "type": "string",
      "metadata": {
        "description": "User name for the ArcGIS (Windows) Service Account"
      },
      "defaultValue": "arcgis"
    },
    "arcgisServiceAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the ArcGIS (Windows) Service Account"
      },
      "defaultValue": ""
    },
    "arcgisServiceAccountIsDomainAccount": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether ArcGIS Service Account is a Domain Account."
      }
    },
    "primarySiteAdministratorAccountUserName": {
      "type": "string",
      "metadata": {
        "description": "User name for the ArcGIS Server Site Primary Site Administrator"
      },
      "defaultValue": "siteadmin"
    },
    "primarySiteAdministratorAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "User name for the ArcGIS Server Site Primary Site Administrator"
      }
    },
    "serverLicenseFileName": {
      "type": "string",
      "metadata": {
        "description": "File name for the ArcGIS Server License"
      },
      "defaultValue": ""
    },
    "portalLicenseFileName": {
      "type": "string",
      "metadata": {
        "description": "File name for the Portal for ArcGIS License"
      },
      "defaultValue": ""
    },
    "portalAdministratorEmail": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Portal administrator email"
      }
    },
    "portalAdminSecurityQuestionIndex": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Portal administrator account security question index."
      }
    },
    "portalAdminSecurityAnswer": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "Portal administrator account security answer."
      }
    },
    "portalLicenseUserTypeId": {
      "type": "string",
      "metadata": {
        "description": "Portal for ArcGIS License User Type Id to be used to Configure Portal Site"
      },
      "defaultValue": ""
    },
    "dataStoreTypes": {
      "type": "string",
      "defaultValue": "Relational",
      "metadata": {
        "description": "(Optional) The types of ArcGIS Data Stores that are enabled for this deployment"
      }
    },
    "dataStoreTypesForBaseDeploymentServers": {
      "type": "string",
      "defaultValue": "Relational",
      "metadata": {
        "description": "(Optional) The types of ArcGIS Data Stores that are enabled for this base deployment servers"
      }
    },
    "useCloudStorage": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether Azure Storage is used for the server config and portal content store"
      }
    },
    "useAzureFiles": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether Azure Files (SMB protocol) is used for the server config and portal content store"
      }
    },
    "usesFileShareVirtualMachine": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether a File Share Virtual Machine is used for the server config and content store"
      }
    },
    "useExistingFileShare": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether an existing File Share is used for the server config store"
      }
    },
    "fileSharePath": {
      "type": "string",
      "metadata": {
        "description": "(Optional) URI for the File Share used for the server config store."
      },
      "defaultValue": ""
    },
    "fileShareName": {
      "type": "string",
      "metadata": {
        "description": "(Optional) Name of the file share on the file share host"
      },
      "defaultValue": "fileshare"
    },
    "cloudStorageAccountName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) Name of the Azure Storage Account used. Required if 'useCloudStorage' is set to true"
      }
    },
    "cloudStorageAccountResourceGroupName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) Name of the resource group for the Azure Storage Account specified with 'cloudStorageAccountName'. Required if 'useCloudStorage' is set to true"
      }
    },
    "cloudStorageAccountKey": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) Storage Account Access Key for the Azure Storage Account specified with 'cloudStorageAccountName'. Required if 'useCloudStorage' is set to true"
      }
    },
    "cloudStorageSASToken": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional)"
      }
    },
    "cloudStorageAuthenticationType": {
      "type": "string",
      "defaultValue": "AccessKey",
      "metadata": {
        "description": "(Optional) "
      }
    },
    "cloudStorageUserAssignedIdentityClientId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) "
      }
    },
    "cloudStorageServicePrincipalTenantId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) "
      }
    },
    "cloudStorageServicePrincipalAuthorityHost": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) "
      }
    },
    "cloudStorageServicePrincipalClientId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) "
      }
    },
    "cloudStorageServicePrincipalClientSecret": {
      "type": "securestring",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) "
      }
    },
    "cloudProvidedObjectStore": {
      "type": "secureObject",
      "defaultValue": {},
      "metadata": {
        "description": "(Optional) Azure Cloud Stores to be registered as cloud-provided Object Store on the ArcGIS Server"
      }
    },
    "cloudStores": {
      "type": "secureObject",
      "defaultValue": {},
      "metadata": {
        "description": "(Optional) Azure Cloud Stores to be registered as Data Items on the ArcGIS Server"
      }
    },
    "enableServerLogHarvesterPlugin": {
      "type": "bool",
      "metadata": {
        "description": "Enable Server Log Harvester Plugin "
      },
      "defaultValue": false
    },
    "databaseOption": {
      "type": "string",
      "defaultValue": "None",
      "allowedValues": [
        "None",
        "AzureSQLDatabase",
        "AzurePostgreSQLDatabase",
        "AzureFlexiblePostgreSQLDatabase",
        "SQLServerDatabase",
        "AzureMISQLDatabase"
      ],
      "metadata": {
        "description": "(Optional) Type of Database registed as an Enterprise Geodatabase"
      }
    },
    "databaseServerAdministratorAccountUserName": {
      "type": "string",
      "metadata": {
        "description": "User name for the Database Server administrator account"
      },
      "defaultValue": ""
    },
    "databaseServerAdministratorAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Database Server administrator account"
      },
      "defaultValue": ""
    },
    "databaseUserAccountUserName": {
      "type": "string",
      "metadata": {
        "description": "User name for the Database User account"
      },
      "defaultValue": ""
    },
    "databaseUserAccountPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Password for the Database User account"
      },
      "defaultValue": ""
    },
    "databaseServerHostName": {
      "type": "string",
      "metadata": {
        "description": "Host name for the Database Server. E.g:- <myServer>.database.windows.net if SQL Database or <myServerFQDN> if SQL Server on IaaS VM"
      },
      "defaultValue": ""
    },
    "databaseName": {
      "type": "string",
      "metadata": {
        "description": "Name of the database"
      },
      "defaultValue": ""
    },
    "enableGeodatabase": {
      "type": "bool",
      "metadata": {
        "description": "Enable Geodatabase on Database to be registered"
      },
      "defaultValue": false
    },
    "_artifactsLocationSasToken": {
      "type": "securestring",
      "metadata": {
        "description": "(SAS) Shared Access Token for the deployment artifacts in an Azure Blob Storage Container"
      },
      "defaultValue": ""
    },
    "_artifactsLocation": {
      "type": "string",
      "metadata": {
        "description": "Fully qualified URL for the deployment artifacts location in an Azure Blob Storage Container"
      },
      "defaultValue": ""
    },
    "debugMode": {
      "type": "bool",
      "metadata": {
        "description": "(Optional) Indicates whether to enable debug settings on the site deployment. Used for troubleshooting only and should not be used for a Production Deployment"
      },
      "defaultValue": false
    },
    "enableRDPAccess": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether Remote Desktop Access to the File Share Machine should be enabled."
      }
    },
    "enableAutoShutDown": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether to enable auto shutdown at specified time."
      }
    },
    "autoShutDownTime": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "(Optional) Auto Shut down time in hh:ss format."
      }
    },
    "enableTrustedLaunch": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether to enable Trusted Launch on the Virtual Machines"
      }
    },
    "secureBootEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether to enable Secure Boot on the Virtual Machines"
      }
    },
    "vTpmEnabled": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Indicates whether to enable Virtual Trusted Platform Module (vTPM) on the Virtual Machines"
      }
    },
    "deploymentTimestamp": {
      "type": "string",
      "defaultValue": "[utcNow()]",
      "metadata": {
        "description": "An optional timestamp used to record as a tag which is used by ArcGIS Deployment Tools"
      }
    },
    "removeAndUninstallExtraArtifacts": {
      "type": "bool",
      "defaultValue": false,
      "metadata": {
        "description": "(Optional) Remove exta artifacts staged or installed on ArcGIS Azure Marketplace images."
      }
    },
    "arcgisDeploymentVersion": {
      "type": "string",
      "metadata": {
        "description": "(Optional) Version number of the ArcGIS Software used in the deployment"
      },
      "defaultValue": "11.5"
    },
    "arcgisDeploymentId": {
      "type": "string",
      "metadata": {
        "description": "Deployment Id required in case of post deployment operations and optional in case of new deployments"
      },
      "defaultValue": ""
    },
    "deploymentTrackingID": {
      "type": "string",
      "metadata": {
        "description": "(Optional) deployment Tracking ID based on Orchestrator being Automation or Cloud Builder "
      },
      "defaultValue": "ce8cb19a-d8ef-4027-9e3e-98e814baca36"
    }
  },
  "variables": {
    "deploymentId": "[if(empty(parameters('arcgisDeploymentId')),uniqueString(resourceGroup().id, concat(parameters('serverContext'), parameters('location')), if(not(empty(parameters('secondaryDnsHostName'))),parameters('secondaryDnsHostName'),parameters('externalDnsHostName'))),parameters('arcgisDeploymentId'))]",
    "computeApiVersion": "2024-07-01",
    "networkApiVersion": "2023-11-01",
    "deploymentsApiVersion": "2024-03-01",
    
    "environmentToBlobEndpoint": {
      "AzureCloud": ".blob.core.windows.net",
      "AzureGermanCloud": ".blob.core.cloudapi.de",
      "AzureUSGovernment": ".blob.core.usgovcloudapi.net",
      "AzureChinaCloud": ".blob.core.chinacloudapi.cn"
    },
    "userAssignedIdentities": {
      "type": "UserAssigned",
      "userAssignedIdentities": "[parameters('userAssignedIdentities')]"
    },
    "publicIPAddressResourceName": "[if(parameters('usesExistingPublicIP'), parameters('existingPublicIPName'), concat(parameters('deploymentPrefix'), 'PublicIP'))]",
    "publicIPAddressRDPResourceName": "[concat(parameters('deploymentPrefix'), 'PublicIP-RDP')]",
    "publicIPAddressLBResourceName": "[concat(parameters('deploymentPrefix'), 'PublicIP-LB')]",
    "publicIPAddressResourceGroupName": "[if(parameters('usesExistingPublicIP'), parameters('existingPublicIPResourceGroupName'), resourceGroup().name)]",
    "unusedPublicIPPWhenUsingPrivateIPDnsPrefix": "[concat('ip',variables('deploymentId'),parameters('serverContext'))]",
    "unusedPublicIPWhenUsingPrivateIPResourceName": "[concat(variables('unusedPublicIPPWhenUsingPrivateIPDnsPrefix'),'UnusedPublicIP')]",
    "vnetID": "[resourceId(parameters('virtualNetworkResourceGroupName'), 'Microsoft.Network/virtualNetworks',parameters('existingVirtualNetworkName'))]",
    "subnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('subnetName'))]",
    "appGatewaySubnetRef": "[concat(variables('vnetID'),'/subnets/',parameters('appGatewaySubnetName'))]",
    "nicName": "nic",
    "baseDeploymentAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-BaseDeployment')]",
    "frontendIPConfigurationsName": "[concat(parameters('deploymentPrefix'), 'EnterpriseAppGatewayFrontendIP')]",
    "publicIPFrontEndConfiguration": [
      {
        "name": "[variables('frontendIPConfigurationsName')]",
        "properties": {
          "PublicIPAddress": {
            "id": "[resourceId(variables('publicIPAddressResourceGroupName'),'Microsoft.Network/publicIPAddresses',variables('publicIPAddressResourceName'))]"
          }
        }
      }
    ],
    "privateIPFrontEndConfiguration": {
      "true": [
        {
          "name": "unusedAppGatewayFrontendPublicIP",
          "properties": {
            "PublicIPAddress": {
              "id": "[resourceId('Microsoft.Network/publicIPAddresses',variables('unusedPublicIPWhenUsingPrivateIPResourceName'))]"
            }
          }
        },
        {
          "name": "[variables('frontendIPConfigurationsName')]",
          "properties": {
            "privateIPAddress": "[parameters('appGatewayPrivateIP')]",
            "privateIPAllocationMethod": "Static",
            "subnet": {
              "id": "[resourceId(parameters('virtualNetworkResourceGroupName'),'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('appGatewayPrivateIPSubnet'))]"
            }
          }
        }
      ],
      "false": [
        {
          "name": "[variables('frontendIPConfigurationsName')]",
          "properties": {
            "privateIPAddress": "[parameters('appGatewayPrivateIP')]",
            "privateIPAllocationMethod": "Static",
            "subnet": {
              "id": "[resourceId(parameters('virtualNetworkResourceGroupName'),'Microsoft.Network/virtualNetworks/subnets', parameters('existingVirtualNetworkName'), parameters('appGatewayPrivateIPSubnet'))]"
            }
          }
        }
      ]
    },
    "frontendport443Name": "[concat(parameters('deploymentPrefix'), 'EnterprisePort443')]",
    "frontendport80Name": "[concat(parameters('deploymentPrefix'), 'EnterprisePort80')]",
    "httpDeploymentListnerName": "[concat(parameters('deploymentPrefix'), 'HttpEnterpriseDeploymentListner')]",
    "httpsDeploymentListnerName": "[concat(parameters('deploymentPrefix'), 'HttpsEnterpriseDeploymentListner')]",
    "urlPathMapsName": "[concat(parameters('deploymentPrefix'), 'EnterprisePathMap')]",
    "redirectConfigurationName": "[concat(parameters('deploymentPrefix'), 'EnterpriseHttpToHttps')]",
    "requestRoutingRule": "[concat(parameters('deploymentPrefix'), 'EnterpriseRequestRoutingRule')]",
    "httpToHttpsRequestRoutingRule": "[concat(parameters('deploymentPrefix'), 'HttpToHttpsEnterpriseRequestRoutingRule')]",
    "serverBackendPoolName": "[concat(parameters('deploymentPrefix'), 'ServerBackendPool')]",
    "portalBackendPoolName": "[concat(parameters('deploymentPrefix'), 'PortalBackendPool')]",
    "portalBackendHttpsSettingName": "[concat(parameters('deploymentPrefix'), 'PortalHttpsSetting')]",
    "serverBackendHttpsSettingName": "[concat(parameters('deploymentPrefix'), 'ServerHttpsSetting')]",
    "serverRewriteRuleSetName": "[concat(parameters('deploymentPrefix'), 'ServerRewriteRuleSet')]",
    "portalRewriteRuleSetName": "[concat(parameters('deploymentPrefix'), 'PortalRewriteRuleSet')]",
    "serverBackendProbeName": "[concat(parameters('deploymentPrefix'), 'ServerProbeName')]",
    "portalBackendProbeName": "[concat(parameters('deploymentPrefix'), 'PortalProbeName')]",
    "dscExtensionArchiveFileName": "DSC.zip",
    "dscScriptFunction": "BaseDeploymentSingleTierConfiguration",
    "tileCacheDataStoreDscScriptFunction": "TileCacheDataStoreConfiguration",
    "spatiotemporalBigDataStoreDscScriptFunction": "SpatiotemporalBigDataStoreConfiguration",
    "graphDataStoreDscScriptFunction": "GraphDataStoreConfiguration",
    "serverDscScriptFunction": "ServerConfiguration",
    "portalDscScriptFunction": "PortalConfiguration",
    "dataStoreDscScriptFunction": "DataStoreConfiguration",
    "fileShareDscScriptFunction": "FileShareConfiguration",
    "dataStoreTypes": "[split(parameters('dataStoreTypes'),',')]",
    "cloudStoreCredentialsPassword": {
      "AccessKey": "[parameters('cloudStorageAccountKey')]",
      "SASToken": "[parameters('cloudStorageSASToken')]",
      "ServicePrincipal": "placeholder",
      "UserAssignedIdentity": "placeholder"
    },
    "cloudStorageAccountCredentialsUserName": {
      "false": "placeholder",
      "true": "[concat(parameters('cloudStorageAccountName'),variables('environmentToBlobEndpoint')[parameters('environment')])]"
    },
    "cloudStorageOption": {
      "true": "[concat(substring(parameters('externalDnsHostName'), 0, indexOf(parameters('externalDnsHostName'),'.')), '@', parameters('cloudStorageAccountName'), variables('environmentToBlobEndpoint')[parameters('environment')], '@', parameters('cloudStorageAccountResourceGroupName'), '@',string(parameters('useAzureFiles')), '@', parameters('cloudStorageAuthenticationType'))]",
      "false": ""
    },
    "virtualMachineNames": "[split(parameters('virtualMachineNames'),',')]",
    "numberOfVirtualMachines": "[length(variables('virtualMachineNames'))]",

    "serverAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-Server')]",
    "serverVirtualMachineNamesAsCommaSeparatedString": "[if(parameters('isMultiTier'),parameters('serverVirtualMachineNames'), parameters('virtualMachineNames'))]",
    "serverVirtualMachineNames": "[split(variables('serverVirtualMachineNamesAsCommaSeparatedString'),',')]",
    "numberOfServerVirtualMachines": "[length(variables('serverVirtualMachineNames'))]",

    "portalAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-Portal')]",
    "portalVirtualMachineNamesAsCommaSeparatedString": "[if(parameters('isMultiTier'),parameters('portalVirtualMachineNames'), parameters('virtualMachineNames'))]",
    "portalVirtualMachineNames": "[split(variables('portalVirtualMachineNamesAsCommaSeparatedString'),',')]",
    "numberOfPortalVirtualMachines": "[length(variables('portalVirtualMachineNames'))]",

    "dataStoreAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-DataStore')]",
    "dataStoreVirtualMachineNames": "[split(if(parameters('isMultiTier'),parameters('dataStoreVirtualMachineNames'), parameters('virtualMachineNames')),',')]",
    "numberOfDataStoreVirtualMachines": "[length(variables('dataStoreVirtualMachineNames'))]",

    "enableSpatiotemporalBigDataStore": "[and(contains(parameters('dataStoreTypes'),'SpatioTemporal'),not(empty(parameters('spatiotemporalBigDataStoreVirtualMachineNames'))))]",
    "spatiotemporalBigDataStoreAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-SpatiotemporalDataStore')]",
    "spatiotemporalBigDataStoreVirtualMachineNames": "[split(parameters('spatiotemporalBigDataStoreVirtualMachineNames'),',')]",
    "numberOfSpatiotemporalBigDataStoreVirtualMachines": "[length(variables('spatiotemporalBigDataStoreVirtualMachineNames'))]",

    "enableTileCacheDataStore": "[and(contains(parameters('dataStoreTypes'),'TileCache'),not(empty(parameters('tileCacheDataStoreVirtualMachineNames'))))]",
    "tileCacheDataStoreAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-TileCacheDataStore')]",
    "tileCacheDataStoreVirtualMachineNames": "[split(parameters('tileCacheDataStoreVirtualMachineNames'),',')]",
    "numberOftileCacheDataStoreVirtualMachines": "[length(variables('tileCacheDataStoreVirtualMachineNames'))]",

    "enableGraphDataStore": "[contains(parameters('dataStoreTypes'),'GraphStore')]",
    "graphDataStoreAvailablitySetName": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-GraphDataStore')]",
    "graphDataStoreVirtualMachineNames": "[split(parameters('graphDataStoreVirtualMachineNames'),',')]",
    "numberOfGraphDataStoreVirtualMachines": "[length(variables('graphDataStoreVirtualMachineNames'))]",

    "AvailabilitySetNameForVM": {
      "TileCacheDataStore": "[variables('tileCacheDataStoreAvailablitySetName')]",
      "SpatiotemporalDataStore": "[variables('spatiotemporalBigDataStoreAvailablitySetName')]",
      "GraphDataStore": "[variables('graphDataStoreAvailablitySetName')]",
      "Server": "[variables('serverAvailablitySetName')]",
      "Portal": "[variables('portalAvailablitySetName')]",
      "DataStore": "[variables('dataStoreAvailablitySetName')]",
      "SQLServerDatabase": "[concat(parameters('deploymentPrefix'), 'AvailabilitySet-SQLServerDatabase')]"
    },
    "tileCacheDataStoreVirtualMachineNameOptions": {
      "true": "[variables('tileCacheDataStoreVirtualMachineNames')]",
      "false": [ "ta" ]
    },
    "graphDataStoreVirtualMachineNameOptions": {
      "true": "[variables('graphDataStoreVirtualMachineNames')]",
      "false": [ "ga" ]
    },
    "spatiotemporalBigDataStoreVirtualMachineNameOptions": {
      "true": "[variables('spatiotemporalBigDataStoreVirtualMachineNames')]",
      "false": [ "sa" ]
    },
    "loadBalancerName": "[concat(parameters('deploymentPrefix'), 'OutboundLoadBalancer')]",
    "frontendIPConfigName": "LbFrontend",
    "backendAddressPoolName": "LbBackendPool",
    "outboundRuleName": "lb-outbound-rule",
    "dataCollectionRuleName": "[concat(parameters('deploymentPrefix'), 'DataCollectionRule-',parameters('serverContext'))]",
    "dataCollectionEndpointName": "[concat(parameters('deploymentPrefix'), 'DataCollectionEndpoint-',parameters('serverContext'))]",
    "databaseServerAdministratorAccountUserName": {
      "true": "placeholder",
      "false": "[parameters('databaseServerAdministratorAccountUserName')]"
    },
    "databaseServerAdministratorAccountPassword": {
      "true": "placeholder",
      "false": "[parameters('databaseServerAdministratorAccountPassword')]"
    },
    "databaseUserAccountUserName": {
      "true": "placeholder",
      "false": "[parameters('databaseUserAccountUserName')]"
    },
    "databaseUserAccountPassword": {
      "true": "placeholder",
      "false": "[parameters('databaseUserAccountPassword')]"
    },
    "databaseServerHostName": {
      "None": "placeholder",
      "AzureSQLDatabase": "[parameters('databaseServerHostName')]",
      "AzurePostgreSQLDatabase": "[parameters('databaseServerHostName')]",
      "AzureFlexiblePostgreSQLDatabase": "[parameters('databaseServerHostName')]",
      "SQLServerDatabase": "[parameters('databaseServerHostName')]",
      "AzureMISQLDatabase": "[parameters('databaseServerHostName')]"
    },
    "sqlServerDscScriptFunction": "SQLServerConfiguration",
    "trustedLaunchSecurityProfile":{
      "true":{
        "uefiSettings": {
            "secureBootEnabled": "[parameters('secureBootEnabled')]",
            "vTpmEnabled": "[parameters('vTpmEnabled')]"
        },
        "securityType": "TrustedLaunch"
      },
      "false":{}
    }
  },
  "resources": [
    {
      "apiVersion": "[variables('deploymentsApiVersion')]",
      "name": "[concat('pid-',parameters('deploymentTrackingID'))]",
      "type": "Microsoft.Resources/deployments",
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "resources": [
          ]
        }
      }
    },
    {
      "condition": "[parameters('enableRDPAccess')]",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressRDPResourceName')]",
      "apiVersion": "[variables('networkApiVersion')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[if(equals(parameters('outboundConnectivityMethod'), 'None'), 'Basic', 'Standard')]"
      },
      "tags": {
        "displayName": "Public IP Address - RDP (Optional)",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "scale": null,
      "properties": {
        "publicIPAllocationMethod": "[if(equals(parameters('outboundConnectivityMethod'), 'None'), 'Dynamic', 'Static')]",
        "idleTimeoutInMinutes": 4,
        "dnsSettings": {
          "domainNameLabel": "[concat(parameters('dnsPrefixForPublicIpAddress'),'-rdp')]"
        }
      }
    },
    {
      "condition": "[or(not(parameters('usesExistingPublicIP')),and(parameters('usesPrivateIP'),parameters('deployPublicIPWhenUsingPrivateIP')))]",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[if(parameters('usesPrivateIP'),variables('unusedPublicIPWhenUsingPrivateIPResourceName'),variables('publicIPAddressResourceName'))]",
      "apiVersion": "[variables('networkApiVersion')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Application Gateway Public IP Address",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "sku": {
        "name": "Standard"
      },
      "scale": null,
      "properties": {
        "publicIPAllocationMethod": "Static",
        "idleTimeoutInMinutes": 11,
        "dnsSettings": {
          "domainNameLabel": "[if(parameters('usesPrivateIP'),variables('unusedPublicIPPWhenUsingPrivateIPDnsPrefix'),parameters('dnsPrefixForPublicIpAddress'))]"
        }
      },
      "dependsOn": [
      ]
    },
    {
      "condition": "[not(parameters('isMultiTier'))]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('baseDeploymentAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Base Deployment Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "condition": "[parameters('isMultiTier')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('serverAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Server Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "condition": "[parameters('isMultiTier')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('portalAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Portal Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "condition": "[parameters('isMultiTier')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('dataStoreAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "DataStore Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "condition": "[variables('enableSpatiotemporalBigDataStore')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('spatiotemporalBigDataStoreAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "(Optional) Big Data Store Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "condition": "[variables('enableGraphDataStore')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('graphDataStoreAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "(Optional) Graph Store Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "condition": "[variables('enableTileCacheDataStore')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/availabilitySets",
      "name": "[variables('tileCacheDataStoreAvailablitySetName')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "(Optional) Tile Cache Data Store Availability Set",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "properties": {
        "platformUpdateDomainCount": 2,
        "platformFaultDomainCount": 2
      },
      "sku": {
        "name": "Aligned"
      }
    },
    {
      "apiVersion": "[variables('networkApiVersion')]",
      "type": "Microsoft.Network/networkInterfaces",
      "name": "[concat(parameters('virtualMachines')[copyIndex()]['VMName'], '-', variables('nicName'))]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Network Interface",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "copy": {
        "name": "nic-copy",
        "count": "[length(parameters('virtualMachines'))]"
      },
      "dependsOn": [
        "[variables('publicIPAddressRDPResourceName')]",
        "[resourceId('Microsoft.Network/loadBalancers', variables('loadBalancerName'))]"
      ],
      "properties": {
        "ipConfigurations": [
          {
            "name": "[if(and(parameters('enableRDPAccess'),equals(parameters('virtualMachines')[copyIndex()]['VMRoles'],'RDPJumpBox')),'jumpbox-ipconfig','ipconfig')]",
            "properties": {
              "privateIPAllocationMethod": "Dynamic",
              "subnet": {
                "id": "[variables('subnetRef')]"
              },
              "publicIPAddress": "[if(and(parameters('enableRDPAccess'),equals(parameters('virtualMachines')[copyIndex()]['VMRoles'],'RDPJumpBox')),json(concat('{\"id\":\"',resourceId('Microsoft.Network/publicIPAddresses',variables('publicIPAddressRDPResourceName')),'\"}')),json('null'))]",
              "loadBalancerBackendAddressPools": "[if(equals(parameters('virtualMachines')[copyIndex()]['VMRoles'],'RDPJumpBox'), json('null'), if(equals(parameters('outboundConnectivityMethod'), 'LoadBalancer'), json(concat('[{\"id\":\"', resourceId(parameters('appGatewayResourceGroupName'), 'Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/backendAddressPools/', variables('backendAddressPoolName'),'\"}]')), json('null')))]"
            }
          }
        ]
      }
    },
    {
      "condition": "[not(empty(parameters('adminPassword')))]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines",
      "name": "[parameters('virtualMachines')[copyIndex()]['VMName']]",
      "location": "[parameters('location')]",
      "identity": "[if(empty(parameters('userAssignedIdentities')),json('null'),variables('userAssignedIdentities'))]",
      "copy": {
        "name": "vm-copy",
        "count": "[length(parameters('virtualMachines'))]"
      },
      "tags": {
        "arcgis-vm-roles": "[parameters('virtualMachines')[copyIndex()]['VMRoles']]",
        "arcgis-deployment-id": "[variables('deploymentId')]",
        "displayName": "[concat(parameters('virtualMachines')[copyIndex()]['VMRoles'],' Virtual Machines')]"
      },
      "plan": "[if(and(equals(string(parameters('virtualMachines')[copyIndex()]['AzureVMImageType']),'0'),not(equals(parameters('virtualMachines')[copyIndex()]['ImageSpec']['Publisher'],'MicrosoftWindowsServer')),not(equals(parameters('virtualMachines')[copyIndex()]['ImageSpec']['Publisher'],'MicrosoftSQLServer'))),json(concat('{\"publisher\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['Publisher'],'\",\"product\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['Offer'],'\",\"name\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['SKU'],'\"}')),json('null'))]",
      "dependsOn": [
        "[concat('Microsoft.Network/networkInterfaces/', parameters('virtualMachines')[copyIndex()]['VMName'], '-', variables('nicName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('baseDeploymentAvailablitySetName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('serverAvailablitySetName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('portalAvailablitySetName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('dataStoreAvailablitySetName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('spatiotemporalBigDataStoreAvailablitySetName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('tileCacheDataStoreAvailablitySetName'))]",
        "[concat('Microsoft.Compute/availabilitySets/', variables('graphDataStoreAvailablitySetName'))]"
      ],
      "properties": {
        "availabilitySet": "[if(or(equals(parameters('virtualMachines')[copyIndex()]['VMRoles'],'RDPJumpBox'),equals(parameters('virtualMachines')[copyIndex()]['VMRoles'],'FileShare'),equals(parameters('virtualMachines')[copyIndex()]['VMRoles'],'SQLServer')),json('null'),json(concat('{\"id\":\"',resourceId('Microsoft.Compute/availabilitySets',if(and(contains(split(parameters('virtualMachines')[copyIndex()]['VMRoles'],','),'Server'),contains(split(parameters('virtualMachines')[copyIndex()]['VMRoles'],','),'Portal'),contains(split(parameters('virtualMachines')[copyIndex()]['VMRoles'],','),'DataStore')),variables('baseDeploymentAvailablitySetName'),variables('AvailabilitySetNameForVM')[parameters('virtualMachines')[copyIndex()]['VMRoles']])),'\"}')))]",
        "hardwareProfile": {
          "vmSize": "[parameters('virtualMachines')[copyIndex()]['VMSize']]"
        },
        "osProfile": {
          "computername": "[parameters('virtualMachines')[copyIndex()]['VMName']]",
          "adminUsername": "[parameters('adminUsername')]",
          "adminPassword": "[parameters('adminPassword')]",
          "windowsConfiguration": {
            "enableAutomaticUpdates": "[parameters('enableAutomaticUpdates')]",
            "timeZone": "[parameters('timeZoneId')]"
          }
        },
        "storageProfile": {
          "imageReference": "[if(equals(string(parameters('virtualMachines')[copyIndex()]['AzureVMImageType']),'0'),json(concat('{\"publisher\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['Publisher'],'\",\"offer\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['Offer'],'\",\"sku\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['SKU'],'\",\"version\":\"latest\"}')),if(equals(string(parameters('virtualMachines')[copyIndex()]['AzureVMImageType']),'1'),json(concat('{\"id\":\"',resourceid(string(parameters('virtualMachines')[copyIndex()]['ImageSpec']['UserImageResourceGroupName']),'Microsoft.Compute/images',parameters('virtualMachines')[copyIndex()]['ImageSpec']['UserImageName']),'\"}')),json(concat('{\"id\":\"',parameters('virtualMachines')[copyIndex()]['ImageSpec']['ComputeGalleryImageVersionResourceId'],'\"}'))))]",
          "osDisk": {
            "name": "[concat(parameters('virtualMachines')[copyIndex()]['VMName'],'-','OSDisk')]",
            "managedDisk": {
              "storageAccountType": "[parameters('virtualMachines')[copyIndex()]['OSDiskType']]"
            },
            "diskSizeGB": "[parameters('virtualMachines')[copyIndex()]['OSDiskSize']]",
            "caching": "[if(less(parameters('virtualMachines')[copyIndex()]['OSDiskSize'],4096),'ReadWrite','None')]",
            "createOption": "FromImage"
          },
          "dataDisks": "[if(equals(length(parameters('virtualMachines')[copyIndex()]['DataDisks']),0),json('null'),parameters('virtualMachines')[copyIndex()]['DataDisks'])]"
        },
        "networkProfile": {
          "networkInterfaces": [
            {
              "id": "[resourceId('Microsoft.Network/networkInterfaces/', concat(parameters('virtualMachines')[copyIndex()]['VMName'], '-',variables('nicName')))]"
            }
          ]
        },
        "securityProfile": "[variables('trustedLaunchSecurityProfile')[string(parameters('enableTrustedLaunch'))]]"
      }
    },
    {
      "condition": "[parameters('enableAutoShutDown')]",
      "apiVersion": "2018-09-15",
      "type": "Microsoft.DevTestLab/schedules",
      "name": "[toLower(concat('shutdown-computevm-', parameters('virtualMachines')[copyIndex()]['VMName']))]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "baseDeploymentServerAutoShutDownCopy",
        "count": "[length(parameters('virtualMachines'))]"
      },
      "dependsOn": [
        "vm-copy"
      ],
      "properties": {
        "status": "[if(parameters('enableAutoShutDown'),'Enabled','Disabled')]",
        "timeZoneId": "[parameters('timeZoneId')]",
        "taskType": "ComputeVmShutdownTask",
        "notificationSettings": {
          "status": "Disabled",
          "timeInMinutes": 15,
          "webhookUrl": ""
        },
        "targetResourceId": "[resourceId('Microsoft.Compute/virtualMachines/', parameters('virtualMachines')[copyIndex()]['VMName'])]",
        "dailyRecurrence": {
          "time": "[parameters('autoShutDownTime')]"
        }
      }
    },
    {
      "condition": "[parameters('joinWindowsDomain')]",
      "apiVersion": "[variables('computeApiVersion')]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('virtualMachines')[copyIndex()]['VMName'],'/JoinDomain')]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "vmDomainJoinCopy",
        "count": "[length(parameters('virtualMachines'))]"
      },
      "dependsOn": [
        "vm-copy"
      ],
      "tags": {
        "displayName": "(Optional) Base Deployment Server Domain Join"
      },
      "properties": {
        "publisher": "Microsoft.Compute",
        "type": "JsonADDomainExtension",
        "typeHandlerVersion": "1.3",
        "autoUpgradeMinorVersion": true,
        "settings": {
          "Name": "[parameters('windowsDomainName')]",
          "User": "[parameters('windowsDomainAdministratorUserName')]",
          "Restart": "true",
          "Options": 3
        },
        "protectedSettings": {
          "Password": "[parameters('windowsDomainAdministratorPassword')]"
        }
      }
    },
    {
      "condition": "[and(not(empty(parameters('logAnalyticsWorkspaceResourceGroupName'))),not(empty(parameters('logAnalyticsWorkspaceName'))))]",
      "apiVersion": "[variables('deploymentsApiVersion')]",
      "name": "[concat('setupmonitoring-',deployment().name)]",
      "type": "Microsoft.Resources/deployments",
      "dependsOn": [
        "vm-copy"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'),'/','setupmonitoring.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "deploymentPrefix": {
            "value": "[parameters('deploymentPrefix')]"
          },
          "serverContext": {
            "value": "[parameters('serverContext')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "logAnalyticsWorkspaceResourceGroupName": {
            "value": "[parameters('logAnalyticsWorkspaceResourceGroupName')]"
          },
          "deploymentId": {
            "value": "[variables('deploymentId')]"
          }
        }
      }
    },
    {
      "condition": "[not(empty(parameters('azureMonitoringAgentUserAssignedIdentityId')))]",
      "type": "Microsoft.Compute/virtualMachines/extensions",
      "name": "[concat(parameters('virtualMachines')[copyIndex()]['VMName'],'/AzureMonitorWindowsAgent')]",
      "location": "[parameters('location')]",
      "copy": {
        "name": "amaCopy",
        "count": "[length(parameters('virtualMachines'))]"
      },
      "apiVersion": "[variables('computeApiVersion')]",
      "dependsOn": [
        "vm-copy"
      ],
      "properties": {
        "publisher": "Microsoft.Azure.Monitor",
        "type": "AzureMonitorWindowsAgent",
        "typeHandlerVersion": "1.0",
        "autoUpgradeMinorVersion": true,
        "enableAutomaticUpgrade": true,
        "settings": {
          "authentication": {
            "managedIdentity": {
              "identifier-name": "mi_res_id",
              "identifier-value": "[parameters('azureMonitoringAgentUserAssignedIdentityId')]"
            }
          }
        }
      }
    },
    {
      "condition": "[and(not(empty(parameters('logAnalyticsWorkspaceResourceGroupName'))),not(empty(parameters('logAnalyticsWorkspaceName'))))]",
      "type": "Microsoft.Insights/dataCollectionRuleAssociations",
      "apiVersion": "2023-03-11",
      "name": "[concat(parameters('virtualMachines')[copyIndex()]['VMName'],'-DCRAssociation')]",
      "copy": {
        "name": "dcrAssociationCopy",
        "count": "[length(parameters('virtualMachines'))]"
      },
      "scope": "[format('Microsoft.Compute/virtualMachines/{0}', parameters('virtualMachines')[copyIndex()]['VMName'])]",
      "dependsOn": [
        "vm-copy",
        "[concat('setupmonitoring-',deployment().name)]"
      ],
      "properties": {
        "dataCollectionRuleId": "[resourceId('Microsoft.Insights/dataCollectionRules', variables('dataCollectionRuleName'))]",
        "description": "[format('Associating {0} VM', parameters('virtualMachines')[copyIndex()]['VMName'])]"
      }
    },
    {
      "name": "[concat('generateSSLCertificatesCustomExtension-',deployment().name)]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deploymentsApiVersion')]",
      "dependsOn": [
        "vmDomainJoinCopy"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'),'/','generatecertificate-cse.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "vmName": {
            "value": "[if(parameters('useExistingFileShare'), variables('serverVirtualMachineNames')[0], parameters('fileShareVirtualMachineName'))]"
          },
          "serverRole": {
            "value": "HostingServer"
          },
          "useSelfSignedInternalSSLCertificate": {
            "value": "[parameters('useSelfSignedInternalSSLCertificate')]"
          },
          "selfSignedSSLCertificatePassword": {
            "value": "[parameters('selfSignedSSLCertificatePassword')]"
          },
          "externalDnsHostName": {
            "value": "[parameters('externalDnsHostName')]"
          },
          "serverInternalCertificateFileName": {
            "value": "[parameters('serverInternalCertificateFileName')]"
          },
          "portalInternalCertificateFileName": {
            "value": "[parameters('portalInternalCertificateFileName')]"
          },
          "fileShareName": {
            "value": "[parameters('fileShareName')]"
          },
          "serverVirtualMachineNames": {
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          "portalVirtualMachineNames": {
            "value": "[variables('portalVirtualMachineNamesAsCommaSeparatedString')]"
          },
          "useExistingFileShare": {
            "value": "[parameters('useExistingFileShare')]"
          },
          "fileSharePath": {
            "value": "[parameters('fileSharePath')]"
          },
          "serverContext": {
            "value": "[parameters('serverContext')]"
          },
          "portalContext": {
            "value": "[parameters('portalContext')]"
          },
          "arcgisServiceAccountUserName": {
            "value": "[parameters('arcgisServiceAccountUserName')]"
          },
          "arcgisServiceAccountPassword": {
            "value": "[parameters('arcgisServiceAccountPassword')]"
          },
          "_artifactsLocation": {
            "value": "[parameters('_artifactsLocation')]"
          },
          "_artifactsLocationSasToken": {
            "value": "[parameters('_artifactsLocationSasToken')]"
          }
        }
      }
    },
    {
      "condition": "[parameters('enableRDPAccess')]",
      "apiVersion": "[variables('deploymentsApiVersion')]",
      "name": "[concat('fetchIpAddress-',deployment().name)]",
      "type": "Microsoft.Resources/deployments",
      "dependsOn": [
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressLBResourceName'))]",
        "[concat('Microsoft.Network/publicIPAddresses/', variables('publicIPAddressRDPResourceName'))]",
        "vm-copy"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[concat(parameters('_artifactsLocation'),'/','fetchIpAddress.json', parameters('_artifactsLocationSasToken'))]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "publicIPAddressId": {
            "value": "[resourceId('Microsoft.Network/publicIpAddresses', variables('publicIPAddressRDPResourceName'))]"
          }
        }
      }
    },
    {
      "condition": "[and(not(empty(parameters('arcgisServiceAccountPassword'))),not(empty(parameters('sslCertificatePassword'))),or(not(empty(parameters('selfSignedSSLCertificatePassword'))),and(not(empty(parameters('serverInternalCertificatePassword'))),not(empty(parameters('portalInternalCertificatePassword'))))))]",
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "[variables('deploymentsApiVersion')]",
      "name": "[concat('appGatewayNestedDeployment-',deployment().name)]",
      "resourceGroup": "[parameters('appGatewayResourceGroupName')]",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'fetchIpAddress-', deployment().name)]",
        "[concat('Microsoft.Resources/deployments/', 'generateSSLCertificatesCustomExtension-', deployment().name)]"
      ],
      "properties": {
        "mode": "Incremental",
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "parameters": {
          },
          "variables": {
          },
          "resources": [
            {
              "type": "Microsoft.Network/applicationGateways",
              "apiVersion": "2022-11-01",
              "name": "[parameters('appGatewayName')]",
              "location": "[parameters('location')]",
              "tags": APPGATEWAYTAGS,
              "properties": APPGATEWAYPROPERTIESOBJECT
            }
          ]
        },
        "parameters": {
        }
      }
    },
    {
      "condition": "[or(empty(parameters('arcgisServiceAccountPassword')), empty(parameters('sslCertificatePassword')), and(empty(parameters('selfSignedSSLCertificatePassword')), or(empty(parameters('serverInternalCertificatePassword')), empty(parameters('portalInternalCertificatePassword')))))]",
      "type": "Microsoft.Resources/tags",
      "apiVersion": "[variables('deploymentsApiVersion')]",
      "scope": "[resourceId(parameters('appGatewayResourceGroupName'), 'Microsoft.Network/applicationGateways', parameters('appGatewayName'))]",
      "name": "default",
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'appGatewayNestedDeployment-',deployment().name)]"
      ],
      "properties": {
        "tags": APPGATEWAYTAGS
      }
    },
    {
      "condition": "[and(not(parameters('useExistingFileShare')),not(empty(parameters('adminPassword'))))]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "name": "[concat(parameters('fileShareVirtualMachineName'),'/FileShareConfigurationDSCRunCMD')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "File Share DSC Script"
      },
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'generateSSLCertificatesCustomExtension-', deployment().name)]"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[string(parameters('arcgisServiceAccountIsDomainAccount'))]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('fileShareDscScriptFunction')]"
          },
          {
            "name": "IsBaseDeployment",
            "value": "True"
          },
          {
            "name": "ExternalDNSHostName",
            "value": "[parameters('externalDnsHostName')]"
          },
          {
            "name": "ServerRole",
            "value": "HostingServer"
          },
          {
            "name": "PortalContext",
            "value": "[parameters('portalContext')]"
          },
          {
            "name": "FileShareName",
            "value": "[parameters('fileShareName')]"
          },
          {
            "name": "DebugMode",
            "value": "[string(parameters('debugMode'))]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "MachineAdministratorCredential",
            "value": "[concat(base64(parameters('adminUsername')),':',base64(parameters('adminPassword')))]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "name": "[concat(variables('serverVirtualMachineNames')[copyIndex()],'/ServerConfigurationDSCRunCMD')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Server DSC Scripts"
      },
      "copy": {
        "name": "Server-DSC-copy",
        "count": "[variables('numberOfServerVirtualMachines')]",
        "mode": "Serial"
      },
      "dependsOn": [
        "[concat(resourceId('Microsoft.Compute/VirtualMachines', parameters('fileShareVirtualMachineName')),'/runCommands/FileShareConfigurationDSCRunCMD')]",
        "[concat(resourceId('Microsoft.Compute/VirtualMachines', variables('databaseServerHostName')[parameters('databaseOption')]),'/runCommands/SQLDSCConfigurationDSCRunCMD')]",
        "[concat('Microsoft.Resources/deployments/', 'appGatewayNestedDeployment-',deployment().name)]"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('serverDscScriptFunction')]"
          },
          {
            "name": "IsMultiTier",
            "value": "[string(parameters('isMultiTier'))]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[parameters('arcgisServiceAccountIsDomainAccount')]"
          },
          {
            "name": "ServerMachineNames",
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "UseExistingFileShare",
            "value": "[string(parameters('useExistingFileShare'))]"
          },
          {
            "name": "FileShareMachineName",
            "value": "[parameters('fileShareVirtualMachineName')]"
          },
          {
            "name": "FileShareName",
            "value": "[parameters('fileShareName')]"
          },
          {
            "name": "FileSharePath",
            "value": "[parameters('fileSharePath')]"
          },
          {
            "name": "ExternalDNSHostName",
            "value": "[parameters('externalDnsHostName')]"
          },
          {
            "name": "UseCloudStorage",
            "value": "[string(parameters('useCloudStorage'))]"
          },
          {
            "name": "UseAzureFiles",
            "value": "[string(parameters('useAzureFiles'))]"
          },
          {
            "name": "EnableLogHarvesterPlugin",
            "value": "[string(parameters('enableServerLogHarvesterPlugin'))]"
          },
          {
            "name": "DebugMode",
            "value": "[string(parameters('debugMode'))]"
          },
          {
            "name": "ServerContext",
            "value": "[parameters('serverContext')]"
          },
          {
            "name": "IsUpdatingCertificates",
            "value": "[string(parameters('isUpdatingCertificates'))]"
          },
          {
            "name": "CloudStorageAuthenticationType",
            "value": "[parameters('cloudStorageAuthenticationType')]"
          },
          {
            "name": "StorageAccountUserAssignedIdentityClientId",
            "value": "[parameters('cloudStorageUserAssignedIdentityClientId')]"
          },
          {
            "name": "StorageAccountServicePrincipalTenantId",
            "value": "[parameters('cloudStorageServicePrincipalTenantId')]"
          },
          {
            "name": "StorageAccountServicePrincipalAuthorityHost",
            "value": "[parameters('cloudStorageServicePrincipalAuthorityHost')]"
          },
          {
            "name": "DatabaseServerHostName",
            "value": "[parameters('databaseServerHostName')]"
          },
          {
            "name": "DatabaseName",
            "value": "[parameters('databaseName')]"
          },
          {
            "name": "DatabaseOption",
            "value": "[parameters('databaseOption')]"
          },
          {
            "name": "EnableGeodatabase",
            "value": "[parameters('enableGeodatabase')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "PublicKeySSLCertificateFileUrl",
            "value": "[if(empty(parameters('publicKeySSLCertificateFileName')), '', concat(parameters('_artifactsLocation'), '/', parameters('publicKeySSLCertificateFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServerLicenseFileUrl",
            "value": "[if(empty(parameters('serverLicenseFileName')), '', concat(parameters('_artifactsLocation'), '/', parameters('serverLicenseFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "ServerInternalCertificatePassword",
            "value": "[if(equals(string(parameters('useSelfSignedInternalSSLCertificate')),'True'), parameters('selfSignedSSLCertificatePassword'), parameters('serverInternalCertificatePassword'))]"
          },
          {
            "name": "SiteAdministratorCredential",
            "value": "[concat(base64(parameters('primarySiteAdministratorAccountUserName')), ':', base64(parameters('primarySiteAdministratorAccountPassword')))]"
          },
          {
            "name": "StorageAccountCredential",
            "value": "[concat(base64(variables('cloudStorageAccountCredentialsUserName')[string(parameters('useCloudStorage'))]), ':', base64(if(parameters('useCloudStorage'), variables('cloudStoreCredentialsPassword')[parameters('cloudStorageAuthenticationType')],'placeholder')))]"
          },
          {
            "name": "StorageAccountServicePrincipalCredential",
            "value": "[concat(base64(if(equals(parameters('cloudStorageAuthenticationType'),'ServicePrincipal'),parameters('cloudStorageServicePrincipalClientId'),'placeholder')), ':', base64(if(equals(parameters('cloudStorageAuthenticationType'),'ServicePrincipal'),parameters('cloudStorageServicePrincipalClientSecret'),'placeholder')))]"
          },
          {
            "name": "DatabaseServerAdministratorCredential",
            "value": "[concat(base64(variables('databaseServerAdministratorAccountUserName')[string(equals(parameters('databaseOption'), 'None'))]), ':', base64(variables('databaseServerAdministratorAccountPassword')[string(equals(parameters('databaseOption'), 'None'))]))]"
          },
          {
            "name": "DatabaseUserCredential",
            "value": "[concat(base64(variables('databaseUserAccountUserName')[string(equals(parameters('databaseOption'), 'None'))]), ':', base64(variables('databaseUserAccountPassword')[string(equals(parameters('databaseOption'), 'None'))]))]"
          },
          {
            "name": "CloudStores",
            "value": "[string(parameters('cloudStores'))]"
          },
          {
            "name": "CloudProvidedObjectStore",
            "value": "[string(parameters('cloudProvidedObjectStore'))]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "name": "[concat(variables('portalVirtualMachineNames')[copyIndex()],'/PortalConfigurationDSCRunCMD')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Portal DSC Scripts"
      },
      "copy": {
        "name": "Portal-DSC-copy",
        "count": "[variables('numberOfPortalVirtualMachines')]",
        "mode": "serial"
      },
      "dependsOn": [
        "[concat('Microsoft.Resources/deployments/', 'appGatewayNestedDeployment-',deployment().name)]",
        "[concat(resourceId('Microsoft.Compute/VirtualMachines', parameters('fileShareVirtualMachineName')),'/runCommands/FileShareConfigurationDSCRunCMD')]",
        "Datastore-DSC-copy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('portalDscScriptFunction')]"
          },
          {
            "name": "IsMultiTier",
            "value": "[string(parameters('isMultiTier'))]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[parameters('arcgisServiceAccountIsDomainAccount')]"
          },
          {
            "name": "PortalLicenseUserTypeId",
            "value": "[if(empty(parameters('portalLicenseUserTypeId')),'',parameters('portalLicenseUserTypeId'))]"
          },
          {
            "name": "ServerMachineNames",
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "PortalMachineNames",
            "value": "[variables('portalVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "UseExistingFileShare",
            "value": "[parameters('useExistingFileShare')]"
          },
          {
            "name": "FileShareMachineName",
            "value": "[parameters('fileShareVirtualMachineName')]"
          },
          {
            "name": "FileShareName",
            "value": "[parameters('fileShareName')]"
          },
          {
            "name": "FileSharePath",
            "value": "[parameters('fileSharePath')]"
          },
          {
            "name": "ExternalDNSHostName",
            "value": "[parameters('externalDnsHostName')]"
          },
          {
            "name": "PrivateDNSHostName",
            "value": "[parameters('secondaryDnsHostName')]"
          },
          {
            "name": "UseCloudStorage",
            "value": "[parameters('useCloudStorage')]"
          },
          {
            "name": "UseAzureFiles",
            "value": "[parameters('useAzureFiles')]"
          },
          {
            "name": "DebugMode",
            "value": "[parameters('debugMode')]"
          },
          {
            "name": "ServerContext",
            "value": "[parameters('serverContext')]"
          },
          {
            "name": "PortalContext",
            "value": "[parameters('portalContext')]"
          },
          {
            "name": "IsUpdatingCertificates",
            "value": "[parameters('isUpdatingCertificates')]"
          },
          {
            "name": "CloudStorageAuthenticationType",
            "value": "[parameters('cloudStorageAuthenticationType')]"
          },
          {
            "name": "StorageAccountUserAssignedIdentityClientId",
            "value": "[parameters('cloudStorageUserAssignedIdentityClientId')]"
          },
          {
            "name": "StorageAccountServicePrincipalTenantId",
            "value": "[parameters('cloudStorageServicePrincipalTenantId')]"
          },
          {
            "name": "StorageAccountServicePrincipalAuthorityHost",
            "value": "[parameters('cloudStorageServicePrincipalAuthorityHost')]"
          },
          {
            "name": "PortalAdministratorEmail",
            "value": "[parameters('portalAdministratorEmail')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "PublicKeySSLCertificateFileUrl",
            "value": "[if(empty(parameters('publicKeySSLCertificateFileName')), '', concat(parameters('_artifactsLocation'), '/', parameters('publicKeySSLCertificateFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "PortalLicenseFileUrl",
            "value": "[if(empty(parameters('portalLicenseFileName')), '', concat(parameters('_artifactsLocation'), '/', parameters('portalLicenseFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "PortalAdministratorSecurityQuestionCredential",
            "value": "[concat(base64(if(empty(parameters('portalAdminSecurityQuestionIndex')),'PlaceHolder', parameters('portalAdminSecurityQuestionIndex'))),':',base64(if(empty(parameters('portalAdminSecurityAnswer')),'PlaceHolder', parameters('portalAdminSecurityAnswer'))))]"
          },
          {
            "name": "PortalInternalCertificatePassword",
            "value": "[if(equals(string(parameters('useSelfSignedInternalSSLCertificate')),'True'), parameters('selfSignedSSLCertificatePassword'), parameters('portalInternalCertificatePassword'))]"
          },
          {
            "name": "SiteAdministratorCredential",
            "value": "[concat(base64(parameters('primarySiteAdministratorAccountUserName')), ':',base64(parameters('primarySiteAdministratorAccountPassword')))]"
          },
          {
            "name": "StorageAccountCredential",
            "value": "[concat(base64(variables('cloudStorageAccountCredentialsUserName')[string(parameters('useCloudStorage'))]), ':', base64(if(parameters('useCloudStorage'), variables('cloudStoreCredentialsPassword')[parameters('cloudStorageAuthenticationType')],'placeholder')))]"
          },
          {
            "name": "StorageAccountServicePrincipalCredential",
            "value": "[concat(base64(if(equals(parameters('cloudStorageAuthenticationType'),'ServicePrincipal'),parameters('cloudStorageServicePrincipalClientId'),'placeholder')), ':', base64(if(equals(parameters('cloudStorageAuthenticationType'),'ServicePrincipal'),parameters('cloudStorageServicePrincipalClientSecret'),'placeholder')))]"
          }
        ]
      }
    },
    {
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "name": "[concat(variables('dataStoreVirtualMachineNames')[copyIndex()],'/DataStoreConfigurationDSCRunCMD')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "DataStore DSC Scripts"
      },
      "copy": {
        "name": "Datastore-DSC-copy",
        "count": "[variables('numberOfDataStoreVirtualMachines')]",
        "mode": "serial"
      },
      "dependsOn": [
        "vmDomainJoinCopy",
        "Server-DSC-copy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('dataStoreDscScriptFunction')]"
          },
          {
            "name": "IsMultiTier",
            "value": "[string(parameters('isMultiTier'))]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[parameters('arcgisServiceAccountIsDomainAccount')]"
          },
          {
            "name": "ServerMachineNames",
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "DataStoreTypes",
            "value": "[if(parameters('isMultiTier'),'Relational', parameters('dataStoreTypesForBaseDeploymentServers'))]"
          },
          {
            "name": "IsDualMachineRelationalDataStore",
            "value": "[string(greater(variables('numberOfDataStoreVirtualMachines'), 1))]"
          },
          {
            "name": "IsMultiMachineTileCacheDataStore",
            "value": "[string(parameters('isMultiMachineTileCacheDataStore'))]"
          },
          {
            "name": "IsTileCacheDataStoreClustered",
            "value": "[string(parameters('isTileCacheDataStoreClustered'))]"
          },
          {
            "name": "IsMultiMachineSpatioTemporalDataStore",
            "value": "[string(parameters('isMultiMachineSpatiotemporalBigDataStore'))]"
          },
          {
            "name": "DebugMode",
            "value": "[string(parameters('debugMode'))]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "SiteAdministratorCredential",
            "value": "[concat(base64(parameters('primarySiteAdministratorAccountUserName')), ':', base64(parameters('primarySiteAdministratorAccountPassword')))]"
          }
        ]
      }
    },
    {
      "condition": "[and(not(parameters('isUpdatingCertificates')),variables('enableTileCacheDataStore'))]",
      "name": "[concat(variables('tileCacheDataStoreVirtualMachineNameOptions')[string(variables('enableTileCacheDataStore'))][copyIndex()],'/TileCacheConfigurationDSCRunCMD')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Tile Cache Data Store DSC Scripts"
      },
      "copy": {
        "name": "TileCache-DSC-copy",
        "count": "[variables('numberOfTileCacheDataStoreVirtualMachines')]",
        "mode": "serial"
      },
      "dependsOn": [
        "vmDomainJoinCopy",
        "Server-DSC-copy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('dataStoreDscScriptFunction')]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[parameters('arcgisServiceAccountIsDomainAccount')]"
          },
          {
            "name": "ServerMachineNames",
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "DataStoreTypes",
            "value": "TileCache"
          },
          {
            "name": "IsMultiMachineTileCacheDataStore",
            "value": "[parameters('isMultiMachineTileCacheDataStore')]"
          },
          {
            "name": "IsTileCacheDataStoreClustered",
            "value": "[parameters('isTileCacheDataStoreClustered')]"
          },
          {
            "name": "DebugMode",
            "value": "[parameters('debugMode')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "SiteAdministratorCredential",
            "value": "[concat(base64(parameters('primarySiteAdministratorAccountUserName')), ':', base64(parameters('primarySiteAdministratorAccountPassword')))]"
          }
        ]
      }
    },
    {
      "condition": "[and(not(parameters('isUpdatingCertificates')),variables('enableSpatiotemporalBigDataStore'))]",
      "name": "[concat(variables('spatiotemporalBigDataStoreVirtualMachineNameOptions')[string(variables('enableSpatiotemporalBigDataStore'))][copyIndex()],'/SpatioTemporalConfigurationDSCRunCMD')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "SpatioTemporal Data Store DSC Scripts"
      },
      "copy": {
        "name": "SpatioTemporal-DSC-copy",
        "count": "[variables('numberOfTileCacheDataStoreVirtualMachines')]",
        "mode": "serial"
      },
      "dependsOn": [
        "vmDomainJoinCopy",
        "Server-DSC-copy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('dataStoreDscScriptFunction')]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[parameters('arcgisServiceAccountIsDomainAccount')]"
          },
          {
            "name": "ServerMachineNames",
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "DataStoreTypes",
            "value": "SpatioTemporal"
          },
          {
            "name": "IsMultiMachineSpatioTemporalDataStore",
            "value": "[parameters('isMultiMachineSpatiotemporalBigDataStore')]"
          },
          {
            "name": "DebugMode",
            "value": "[parameters('debugMode')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "SiteAdministratorCredential",
            "value": "[concat(base64(parameters('primarySiteAdministratorAccountUserName')), ':', base64(parameters('primarySiteAdministratorAccountPassword')))]"
          }
        ]
      }
    },
    {
      "condition": "[and(variables('enableGraphDataStore'),not(empty(parameters('graphStoreBackupStorageAccountEndpoint'))),not(empty(parameters('graphStoreBackupStorageAccountKey'))))]",
      "name": "[concat(parameters('primaryGraphStoreMachineName'),'/GraphStoreBackupConfigurationDSCRunCMD')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Graph Data Store Backup DSC Scripts"
      },
      "copy": {
        "name": "GraphStoreBackup-DSC-copy",
        "count": 1,
        "mode": "serial"
      },
      "dependsOn": [
        "vmDomainJoinCopy",
        "Server-DSC-copy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "GraphStoreBackupConfiguration"
          },
          {
            "name": "GraphBackupLocation",
            "value": "[parameters('graphStoreBackupLocation')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "GraphBackupCredential",
            "value": "[concat(base64(if(empty(parameters('graphStoreBackupStorageAccountEndpoint')),'PlaceHolder', parameters('graphStoreBackupStorageAccountEndpoint'))), ':', base64(if(empty(parameters('graphStoreBackupStorageAccountKey')),'PlaceHolder', parameters('graphStoreBackupStorageAccountKey'))))]"
          }
        ]
      }
    },
    {
      "condition": "[and(not(parameters('isUpdatingCertificates')),variables('enableGraphDataStore'))]",
      "name": "[concat(variables('graphDataStoreVirtualMachineNameOptions')[string(variables('enableGraphDataStore'))][copyIndex()],'/GraphStoreConfigurationDSCRunCMD')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "Graph Data Store DSC Scripts"
      },
      "copy": {
        "name": "GraphStore-DSC-copy",
        "count": "[variables('numberOfGraphDataStoreVirtualMachines')]",
        "mode": "serial"
      },
      "dependsOn": [
        "vmDomainJoinCopy",
        "Server-DSC-copy",
        "GraphStoreBackup-DSC-copy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('dataStoreDscScriptFunction')]"
          },
          {
            "name": "ServiceCredentialIsDomainAccount",
            "value": "[parameters('arcgisServiceAccountIsDomainAccount')]"
          },
          {
            "name": "ServerMachineNames",
            "value": "[variables('serverVirtualMachineNamesAsCommaSeparatedString')]"
          },
          {
            "name": "DataStoreTypes",
            "value": "GraphStore"
          },
          {
            "name": "IsMultiMachineGraphStore",
            "value": "[string(greater(variables('numberOfGraphDataStoreVirtualMachines'),2))]"
          },
          {
            "name": "DebugMode",
            "value": "[parameters('debugMode')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "ServiceCredential",
            "value": "[concat(base64(if(empty(parameters('arcgisServiceAccountUserName')),'PlaceHolder', parameters('arcgisServiceAccountUserName'))), ':', base64(if(empty(parameters('arcgisServiceAccountPassword')),'PlaceHolder', parameters('arcgisServiceAccountPassword'))))]"
          },
          {
            "name": "SiteAdministratorCredential",
            "value": "[concat(base64(parameters('primarySiteAdministratorAccountUserName')), ':', base64(parameters('primarySiteAdministratorAccountPassword')))]"
          }
        ]
      }
    },
    {
      "condition": "[and(not(parameters('isUpdatingCertificates')),equals(string(parameters('databaseOption')), 'SQLServerDatabase'))]",
      "name": "[concat(variables('databaseServerHostName')[parameters('databaseOption')],'/SQLDSCConfigurationDSCRunCMD')]",
      "type": "Microsoft.Compute/virtualMachines/runCommands",
      "apiVersion": "[variables('computeApiVersion')]",
      "location": "[parameters('location')]",
      "tags": {
        "displayName": "(Optional) SQL Server DSC Scripts"
      },
      "dependsOn": [
        "vmDomainJoinCopy"
      ],
      "properties": {
        "source": {
          "scriptUri": "[concat(parameters('_artifactsLocation'),'/','RunCommandInvokeARMTemplateDSC.ps1', parameters('_artifactsLocationSasToken'))]"
        },
        "treatFailureAsDeploymentFailure": true,
        "parameters": [
          {
            "name": "Version",
            "value": "[parameters('arcgisDeploymentVersion')]"
          },
          {
            "name": "ConfigurationName",
            "value": "[variables('sqlServerDscScriptFunction')]"
          },
          {
            "name": "DebugMode",
            "value": "[parameters('debugMode')]"
          }
        ],
        "protectedParameters": [
          {
            "name": "DSCZipFileUrl",
            "value": "[uriComponent(concat(parameters('_artifactsLocation'),'/',variables('dscExtensionArchiveFileName'), parameters('_artifactsLocationSasToken')))]"
          },
          {
            "name": "DatabaseServerAdministratorCredential",
            "value": "[concat(base64(variables('databaseServerAdministratorAccountUserName')[string(equals(parameters('databaseOption'), 'None'))]),':',base64(variables('databaseServerAdministratorAccountPassword')[string(equals(parameters('databaseOption'), 'None'))]))]"
          }
        ]
      }
    },
    {
      "condition": "[and(not(parameters('isUpdatingCertificates')),equals(parameters('outboundConnectivityMethod'), 'LoadBalancer'))]",
      "type": "Microsoft.Network/publicIPAddresses",
      "name": "[variables('publicIPAddressLBResourceName')]",
      "apiVersion": "[variables('networkApiVersion')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard"
      },
      "tags": {
        "displayName": "Public IP Address - LB",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "scale": null,
      "properties": {
        "publicIPAllocationMethod": "Static",
        "idleTimeoutInMinutes": 4,
        "dnsSettings": {
          "domainNameLabel": "[concat(if(parameters('usesPrivateIP'),'',concat(parameters('dnsPrefixForPublicIpAddress'),'-')),'lb-', variables('deploymentId'))]"
        }
      }
    },
    {
      "condition": "[and(not(parameters('isUpdatingCertificates')),equals(parameters('outboundConnectivityMethod'), 'LoadBalancer'))]",
      "type": "Microsoft.Network/loadBalancers",
      "apiVersion": "[variables('networkApiVersion')]",
      "name": "[variables('loadBalancerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard"
      },
      "tags": {
        "displayName": "Load Balancer",
        "arcgis-deployment-id": "[variables('deploymentId')]"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressLBResourceName'))]"
      ],
      "properties": {
        "frontendIPConfigurations": [
          {
            "name": "[variables('frontendIPConfigName')]",
            "properties": {
              "publicIPAddress": {
                "id": "[resourceId('Microsoft.Network/publicIPAddresses', variables('publicIPAddressLBResourceName'))]"
              }
            }
          }
        ],
        "backendAddressPools": [
          {
            "name": "[variables('backendAddressPoolName')]"
          }
        ],
        "outboundRules": [
          {
            "name": "[variables('outboundRuleName')]",
            "properties": {
              "frontendIPConfigurations": [
                {
                  "id": "[concat(resourceId(parameters('appGatewayResourceGroupName'), 'Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/frontendIPConfigurations/', variables('frontendIPConfigName'))]"
                }
              ],
              "backendAddressPool": {
                "id": "[concat(resourceId(parameters('appGatewayResourceGroupName'), 'Microsoft.Network/loadBalancers', variables('loadBalancerName')), '/backendAddressPools/', variables('backendAddressPoolName'))]"
              },
              "protocol": "All",
              "idleTimeoutInMinutes": 4,
              "allocatedOutboundPorts": 1024
            }
          }
        ]
      }
    }
  ],
  "outputs": {
    "homeAppUrl": {
      "type": "string",
      "value": "[concat('https://', parameters('externalDnsHostName'))]"
    }
  }
}